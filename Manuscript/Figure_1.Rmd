---
output: pdf_document
header-includes:
- \usepackage{caption,setspace}
- \captionsetup[figure]{labelformat=empty}
---

\captionsetup[table]{labelformat=empty}

```{r, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE,fig.align="center", fig.height=12, fig.width=12,fig.cap="Figure 1. Phylogenetic relationship and degree of habitat occupancy for the selected bee species with brain weight and intertegular distance information (N=89). A) Phylogenetic tree at the genus level. Tree branches are coloured based on the geographical location of the different bee species (North of Europe, East Coast of the United States or from both regions). The deviation of the brain size in relation to the body (i.e., residuals) is represented with filled circles of proportional area at the end of the tip branches. Larger circles indicate larger brains in proportion to their body size and vice versa. B) Heatmap showing the degree of habitat occupancy for each bee species. The columns delimit the habitat type (i.e., natural, agricultural and urban) and the rows the different bee species."}

library(ggtree) #v3.5.3.002
library(ggplot2)
library(stringr)
library(tidyverse)
library(tibble)

#Load phylogenetic data from europe
bee.tree100 = readRDS("../Data/Europe_USA/bee.tree100.rds")
#Load brain data
brain_weight = readr::read_csv("../Data/Processing/brain_weight_data.csv")
#Load preferences data
preferences_usa = readr::read_csv("../Data/USA_data/preferences_usa.csv") 
preferences_eu = readr::read_csv("../Data/Europe_data/preferences_europe.csv") 
#Bind rows
pref = bind_rows(preferences_usa, preferences_eu)

#Average preferences between USA and Europe
preferences = pref %>% 
group_by(Species) %>%
summarise(across(everything(), list(mean),.names = "{.col}")) %>% 
ungroup()

#Delete underscore from tree
bee.tree100$tip.label = str_replace(bee.tree100$tip.label, "_", " ")

#Generate vector with species
v = bee.tree100$tip.label
#Filter species with that are in the phylo
brain_weight = brain_weight %>% filter(Species %in% v)

#Fill a column based on condition
brain_weight = brain_weight %>% 
    mutate(Country = case_when((brain_weight$Species %in% preferences_eu$Species & 
    brain_weight$Species %in% preferences_usa$Species ~ "USA and Europe"),
    (brain_weight$Species %in% preferences_usa$Species ~ "USA"),
    (brain_weight$Species %in% preferences_eu$Species ~ "Europe")))

#Plot tree
p <- ggtree(bee.tree100) %<+% brain_weight  +  aes(color=Country)+
    geom_tippoint(aes(size = residuals, color=Country))+
    theme_tree2()+scale_size_continuous(range = c(-1, 4),name="Relative\nbrain size")+
    scale_color_manual(name = "Data", values=c("darkgoldenrod1","cyan4","black"),
                       labels = c("Europe", "USA", "USA and Europe"),
                       breaks = c("Europe", "USA", "USA and Europe")) +
  ggtitle("A") + theme(plot.title = element_text(size=18, face="bold"))

#Convert wide format to long for plotting heatmap
d=gather(preferences, condition, measurement, Agricultural:Urban, factor_key=TRUE)

#Relevel for plotting
d = d %>% 
mutate(condition=fct_relevel(condition,c("Natural","Agricultural", "Urban"))) 

p2 = ggplot(d, aes(x=condition, y=Species)) + 
    geom_tile(aes(fill=measurement),color = "white") +
   # scale_fill_gradient(high="black",  low="white") +
  scale_fill_continuous("Habitat occupancy",type = "viridis", 
                        breaks = c(0, 0.5,  1), 
                        labels = c("0 (Low)", "0.5","1 (High)")) +
  
  #  scale_fill_viridis_c(name = "Habitat\noccupancy") + 
    theme_minimal() +
    xlab(NULL) + 
    ylab(NULL) + 
    theme(axis.text.x = element_text(face="bold", color="black", 
    size=7.5,  vjust=1.15),
    axis.text.y = element_text(face="italic", color="black", size=7.5, hjust=0),
    plot.title = element_text(size=18, face="bold")) +
   ggtitle("B")

#Nice way to insert ordered heatmap
library(aplot)
p2 %>% insert_left(p) 
```
