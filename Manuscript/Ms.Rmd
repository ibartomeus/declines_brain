---
title: "Bees need larger brains to thrive in urban environments"
output:
  pdf_document:
    fig_caption: yes
  word_document: default
link-citations: yes
linkcolor: RoyalBlue
urlcolor: RoyalBlue
fontsize: 12pt
bibliography: references.bib
always_allow_html: true
header-includes:
- \usepackage{orcidlink}
- \usepackage{caption,setspace}
- \captionsetup[figure]{labelformat=empty}
- \usepackage{float}
- \floatplacement{figure}{H}
csl: BiologyLetters.csl
---

\captionsetup[table]{labelformat=empty}

```{r echo=FALSE,warning=FALSE}

knitr::opts_chunk$set(fig.pos = "H", out.extra = "")
```

\textbf{Jose B. Lanuza$^{1}$} \orcidlink{0000-0002-0287-409X} \textbf{, Miguel Á. Collado$^{1,2}$} \orcidlink{0000-0002-4216-317X} \textbf{, Ferran Sayol$^{3}$} \orcidlink{0000-0003-3540-7487} \textbf{, Daniel Sol$^{3}$} \orcidlink{0000-0001-6346-6949} \textbf{and Ignasi Bartomeus$^{1}$} \orcidlink{0000-0001-7893-4389}

Jose B. Lanuza$^{1}$ https://orcid.org/0000-0002-0287-409X, Miguel Á. Collado$^{1,2}$ https://orcid.org/0000-0002-4216-317X, Ferran Sayol$^{3}$ https://orcid.org/0000-0003-3540-7487, Daniel Sol$^{3}$ https://orcid.org/0000-0001-6346-6949 and Ignasi Bartomeus$^{1}$ https://orcid.org/0000-0001-7893-4389


$^{1}$Estación Biológica de Doñana (EBD-CSIC), E-41092 Seville, Spain

$^{2}$Departamento de Ciencias de la Computación e Inteligencia Artificial, Universidad de Sevilla, Seville, Spain

$^{3}$Centre for Ecological Research and Forestry Applications (CREAF), Bellaterra, Catalonia, Spain

**Author for correspondence: barragansljose\@gmail.com**

\textbf{Author for correspondence: barragansljose@gmail.com}


```{r Taxonomic information about the dataset, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE}

library(readr)
library(dplyr)

#Load final dataset 
raw = read_csv("../Raw_data/all_cleaning.csv")

d = raw %>% 
group_by(Species) %>% 
summarise(individuals = n())
#Load preferences data
preferences_usa = readr::read_csv("../Data/USA_data/preferences_usa.csv") 
preferences_eu = readr::read_csv("../Data/Europe_data/preferences_europe.csv") 
#Bind rows
pref = bind_rows(preferences_usa, preferences_eu)
s = unique(pref$Species)

raw = raw %>% filter(Species %in% s)

#Load taxonomic rank script
tax = read_csv("../Data/Processing/taxonomic_rank.csv")



```

# Abstract

The rapid conversion of natural habitats to anthropogenic landscapes is threatening insect pollinators worldwide, raising concern on the consequences for their fundamental role as plant pollinators. However, not all pollinators are negatively affected by habitat conversion, as certain species find in anthropogenic landscapes appropriate resources to persist and proliferate. The reason why some species thrive in anthropogenic environments while most find them inhospitable remains poorly understood. The cognitive buffer hypothesis, widely supported in vertebrates but untested in insects, offers a potential explanation. This theory suggests that species with larger brains have enhanced behavioural plasticity, enabling them to confront and adapt to novel challenges. To investigate this hypothesis in insects, we measured brains for `r nrow(raw)` individuals from `r nlevels(factor(unique(raw$Species)))` bee species, and evaluated the association of their brain sizes with detailed information on habitat preferences. Our analyses revealed that bees that prefer urban habitats had larger brains relative to their body size than those who prefer forested or agricultural habitats. Additionally, urban bees exhibited larger body sizes and, consequently, larger absolute brain sizes. Our results provide the first empirical support for the cognitive buffer hypothesis in invertebrates, suggesting that a large brain in bees could confer behavioural advantages to tolerate urban environments.

Keywords: relative brain size, habitat preference, Apoidea, urbanisation, pollinators

\clearpage

# 1. Introduction

Pollinators deliver a fundamental ecosystem service on which the earth's vegetation and human economy depend [@ollerton2017]. Regrettably, there is increasing evidence of recent declines in pollinator populations [@bartomeus2019; @potts2010; @scheper2014]. One of the main contributing factors to the current pollinator declines is the alteration and loss of their habitat due to human activity [@harrison2015; @harrison2018]. Anthropogenic landscapes present new challenges for the survival and reproduction of organisms, increasing their risk of extinction by maldaptation [@winfree2011; @brown2009 ; @harrison2019]. Yet, not all pollinator species are negatively affected by land use change. For instance, some bee species are able to tolerate human-altered environments [@biesmeijer2006; @bartomeus2013; @collado2019] or even to thrive [e.g., *Bombus terrestris*\; @rasmont2008; @theodorou2020].

Human-dominated habitats ---notably cities--- drastically modify the original conditions where pollinators evolved, but can also offer unique ecological opportunities in the form of new nesting spots, reduced predation pressure and high food availability associated with non-indigenous plants [@cane2006; @winfree2011; @collado2019]. The question is then why only some species are able to tolerate urban environments. The "cognitive buffer hypothesis" provides an explanation for this conundrum, suggesting that in novel environments the chances to successfully survive and reproduce depends on cognition [@sol2009], that is, the processes involved in gathering, storing and reacting to environmental information [@shettleworth2009]. While the "cognitive buffer hypothesis" receives ample support from studies of vertebrates [@sol2008; @amiel2011; @sayol2016; @howell2023], similar evidence is lacking for insects.

Insects have been long associated with the most basic types of learning due to their miniature brain [@giurfa2015; @perry2017]. However, numerous recent studies have shown that bees and other insects have sophisticated cognition that goes beyond simple associative learning or conditioning [@chittka2009; @avargues2011; @sheehan2011]. Some of these more complex forms of cognition involve the use of simple tools, attention, social learning or metacognitive processes [@giurfa2015; @perry2017]. In addition, there is also evidence for substantial variation across species in brain size---both in absolute terms and relative to body size--- with species that have larger brains also exhibiting enhanced cognitive performance [@collado2021]. Therefore, we can ask whether the varying success of insects in human-altered habitats might be explained by variation in brain size.

Here, we report the first test of the "cognitive-buffer hypothesis" in insects. Our test is based on a unique database of brain measures for `r nlevels(factor(unique(raw$Species)))` European and North American bee species. By means of detailed georeferenced information of species occurrences (GBIF; <http://www.gbif.org/>), we characterise habitat preferences for all the species, and use a phylogenetically-informed comparative analysis to assess whether bees that proliferate in human-altered habitats have enlarged brains compared to those that avoid them.

\clearpage

# 2. Methods

```{r Trait info, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE}
library(dplyr)
#Load brain data
brain_weight = readr::read_csv("../Data/Processing/brain_weight_data.csv")
#Load preferences data
preferences_usa = readr::read_csv("../Data/USA_data/preferences_usa.csv") 
preferences_eu = readr::read_csv("../Data/Europe_data/preferences_europe.csv") 
#Bind rows
pref = bind_rows(preferences_usa, preferences_eu)
#Select unique species
sp = pref %>% distinct(Species) %>% pull()

#Filter species that are in the phylo
brain_weight = brain_weight %>% filter(Species %in% sp)
largest_encephalisation = brain_weight %>% filter(residuals == max(residuals)) %>% select(Species) %>% pull()
lowest_encephalisation = brain_weight %>% filter(residuals == min(residuals)) %>% select(Species) %>% pull()

#Read model output
r2 = read_rds("../Data/Processing/bayessianr2.rds")
r2 = round(r2[1],2)

#Read phylo signal
phylo = read_rds("../Data/Processing/phylo_signal.rds")
lambda = round(phylo$lambda, 2)
phylo_nat = read_rds("../Data/Processing/phylo_signal_natural.rds")
lambda_nat = round(phylo_nat$lambda, 2)
p_nat = round(phylo_nat$P,2)

#Read summary of habitat preference
#Load preferences data
preferences_usa = readr::read_csv("../Data/USA_data/preferences_usa.csv") 
preferences_eu = readr::read_csv("../Data/Europe_data/preferences_europe.csv") 
#Bind rows
pref = bind_rows(preferences_usa, preferences_eu)
#Average preferences between USA and Europe
preferences = pref %>% 
group_by(Species) %>%
summarise(across(everything(), list(mean),.names = "{.col}")) %>% 
ungroup()
#Agricultural
pref_agr = pref %>% 
dplyr::select(Agricultural) %>%  
filter(Agricultural > 0.80) %>% 
nrow()
#Natural
pref_nat = pref %>% 
dplyr::select(Natural) %>%  
filter(Natural > 0.80) %>% 
nrow()
#Urban
pref_urb1 = pref %>% 
dplyr::select(Urban) %>%  
filter(Urban < 0.20) %>% 
nrow()
#Urban
pref_urb2 = pref %>% 
dplyr::select(Urban) %>%  
filter(Urban > 0.80) %>% 
nrow()

#Read R2 MAIN MODEL
r2_main = readRDS("../Data/Processing/r2_main.rds")
r2_main = round(r2_main[[1]],2)
#Read R2 MODEL BRAIN WEIGHT
r2_brain = readRDS("../Data/Processing/r2_brain.rds")
r2_brain = round(r2_brain[[1]],2)
#Read R2 MODEL ITS
r2_its = readRDS("../Data/Processing/r2_its.rds")
r2_its = round(r2_its[[1]],2)

```

## (a) Brain measurements

Our dataset contains measurements of brain and body size for bee specimens captured on flowers by hand netting in different areas of the East Coast of the United States and Europe (Spain and the Netherlands). The dataset includes information of `r nrow(raw)` female individuals from `r nlevels(factor(unique(raw$Species)))` species that represent `r nlevels(factor(unique(tax$family)))` families and `r nlevels(factor(unique(tax$genus)))` genera. We only considered female specimens because: (i) they are involved in a greater diversity of tasks than males, and hence are expected to experience greater environmental pressures; and (ii), have brains that are structurally and functionally different from those of males [@streinzer2013; @roselino2015]. Brain size was measured as the weight of fixed brains [@sayol2020] and body size as intertegular span [@kendall2019; see supplementary text]. Given that brain size scales allometrically with body size [@sayol2020], we considered for our analysis the size of the brain relative to the body.

Following @sayol2020, we estimated relative brain size as the residuals of a log-log phylogenetic linear model of brain mass against body size, using the Bayesian approximation implemented in the function *brm* from the package *brms* version 2.18 [@burkner2017]. The phylogeny was built with the help of a previously published genus-level phylogeny and it was processed with the help of the packages ape 5.6-2 [@paradis2019], phytools 1.2-0 [@revell2012] and MCMCglmm version 2.33 [@hadfield2010]. High values of relative brain size indicate larger brains than expected for their body size and low values denote smaller brains than expected. Our bee dataset showed a strong allometric relationship between brain and body size (Bayesian R$^2$ = `r r2`) that was constrained by the evolutionary history of the species (phylogenetic signal of relative brain size, $\lambda$ = `r lambda`; *P* \< 0.01). However, we found considerable variability in relative brain size within and across the different taxonomic groups (i.e., genera and subfamily level; Figure S1; Figure 1A).

## (b) Habitat preferences

```{r Loading study site areas, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE}

#Calculate study site areas
#Load libraries
library(sf)
library(sfheaders)

#EUROPE:
#Read data
euro_map <- st_read("../Data/Europe_data/euro_map_1.shp", quiet = TRUE)
#Add area col
euro_map$area <- st_area(euro_map)
#Create dataframe with the correct units
d1 = euro_map %>% group_by(CNTR_CODE) %>% summarize(st_union(geometry), area_NAME = sum(area)) %>% 
mutate(areakm2 = units::set_units(area_NAME, value = "km^2"))
#Calculate area
eukm2 = prettyNum(as.numeric(round(sum(d1$areakm2),0)),big.mark=",")

#USA:
#Read data
usa_states_1 <- read.csv("../Data/Usa_data/usa_states.csv")
#Not an sf object, convert into multypolygon
usa = sfheaders::sf_multipolygon(
  obj = usa_states_1
  , multipolygon_id = "group"
  , x = "long"
  , y = "lat"
) %>% st_set_crs(4326)
#Calculate area
usa$area <- st_area(usa)
#Create dataframe with the correct units
d2 = usa %>% group_by(group) %>% summarize(st_union(geometry), area_NAME = sum(area)) %>% 
mutate(areakm2 = units::set_units(area_NAME, value = "km^2"))
#Sum areas
usakm2 = prettyNum(as.numeric(round(sum(d2$areakm2),0)),big.mark=",")

```

```{r Species and occurrences info, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE}

#Read occurrence records and extract relevant info
#Load libraries
library(data.table)
#Load clean data with bee occurrences
europe <- read.table("../Data/Europe_data/all_above_50_europe.csv.gz",  header=T, quote="\"", sep=",")
usa <- read.table("../Data/Usa_data/all_above_50_usa.csv.gz",  header=T, quote="\"", sep=",") 

#Europe
eu_occurrences = prettyNum(nrow(europe), big.mark=",")
records_eu = europe %>% 
group_by(species) %>% 
summarize(no_rows= length(species))

#USA
usa_occurrences = prettyNum(nrow(usa), big.mark=",")
records_usa = usa %>% 
group_by(species) %>% 
summarize(no_rows= length(species))

#Number of species
usa_spp = nrow(records_usa)
eu_spp = nrow(records_eu)
spp_number = nrow(bind_rows(records_eu, records_usa) %>% distinct(species))
spp_shared = nrow(bind_rows(records_eu, records_usa)) - nrow(bind_rows(records_eu, records_usa) %>% distinct(species))

#Median number of records per dataset
eu_median = median(records_eu$no_rows)
usa_median = median(records_usa$no_rows)

#Load now dataset with full set of species
all_spp = readRDS("../Data/Processing/wit.mean.rds")
spp_number_nofilter = nrow(all_spp) #total number of species

```

We downloaded occurrence information for all the measured species from the Global Biodiversity Information Facility (GBIF; <http://www.gbif.org/>) for North America and Europe. The data was downloaded through R programming language with the help of the function *occ_download* from the package *rgbif* version 3.7.3 [@chamberlain2017]. We selected the states or countries with the highest density of records for our set of species. For North America, we selected states located on the East Coast of the United States (Figure S2A), covering an approximate area of `r usakm2` km$^{2}$. For Europe, we selected countries located on the north and centre of the continent (Figure S2B), representing a total area of `r eukm2` km$^{2}$. To further reduce biases in the data, we only included species with a minimum number of 50 records and whose geographic distribution was larger than the sampled area (i.e., excluding species at the edge of their distributions). In addition, we optimised the match between species occurrence and the land cover data by only using georeferenced records obtained between 1990 and 2022 with a minimum of two decimals of latitude/longitude coordinates.

We assigned a habitat type to each GBIF occurrence by merging land cover information with the georeferenced records of species occurrences. The land cover classification was obtained from the 2006 online inventories of the National Land Cover Database (NLCD) for United States and the Corine Land Cover (CLC) for Europe. After downloading these inventories as raster files, we used the functions *rast* and *extract* from the *Terra* package version 1.6-41 [@hijmans2022] to read and obtain the cover classification of the different georeferenced records, respectively. To simplify the interpretation and conduct a joint analysis for both regions, we divided the resulting cover classes into three single categories: (i) natural, (ii) agricultural and (iii) urban (see Tables S1 and S2 for details). With this information we can build an occurrence matrix with species in rows, habitats in columns, and cells depicting the number of occurrences per species-habitat combination.

Habitat preferences were estimated by assessing whether the occurrences of species in a given habitat were more frequent than expected by chance. For this, we generated 10,000 randomised matrices based on the occurrence matrix with the function *nullmodel* from the package *bipartite* version 2.16 [@dormann2008]. We used the method 'r2dtable', which maintains row and column sums constant by using Patefield's algorithm [@patefield1981]. This maintains the proportional dominance of the species and habitats constant but reshuffles their associations. We then estimated the percentage of simulated occurrences per species and habitat that were under the observed ones (i.e., percentile). Lastly, we considered that a bee species exhibited a "high preference" for any of the three studied habitats when the number of occurrences observed in this habitat exceeded the 80th percentile of the values obtained from the simulations. On the contrary, the species was considered to exhibit "low preference or avoidance" for the habitat when the observed occurrences were below the 20th percentile. To better understand if our findings are affected by the evolutionary histories of the species, we estimated the phylogenetic signal of relative brain size and habitat preference across habitats for our set of species with the help of the function *phylosig* from the *phytools* package.

## (d) Analysis

To evaluate how the association between habitat preference and relative brain size changed by habitat type, we modelled with Bayesian generalised linear models their association. For this, we first joined the resulting habitat preference and relative brain size datasets by species. The resulting distribution of habitat preferences for each of the habitats analysed followed a zero-one inflated beta distribution (Figure S3), indicating that there were high frequencies of habitat preferences close to 0 or 1 but low frequencies of intermediate values between 0 and 1. Hence, in our analyses we take a conservative approach and only modelled the extremes of the distribution (i.e., species classified as avoiding or preferring a given habitat). Because we assessed habitat preference as binary ("avoiding" or "preferring"), we specified a Bernouilli distribution where habitat preference was the response variable and relative brain size the predictor. Again, we included the phylogenetic covariance matrix as a random factor. Moreover, we also explored how habitat preference changed by brain weight and intertegular span independently. For this, we conducted two analogous models with these two different predictors. In addition, we also investigated the different trends for the United States and Europe separately.

All our models were run with 4,000 iterations with previous 1,000 warm up iterations, using non-informative or weakly informative priors [@burkner2017]. Further, the different posterior predictive checks were conducted with the function *pp_check*, also from the *brms* package. All our analyses were undertaken in R version 4.0.5 [@r2021], and all data processing and graphics were done with the set of packages from the tidyverse version 1.3.0 [@tidyverse19].

# 3. Results

Habitat preference varied substantially across species (Figure 1B) and showed moderate phylogenetic signal (i.e., preference for natural habitat; $\lambda$ = `r lambda_nat`; *P* = `r p_nat`). In general, most bee species preferred one or two habitat types but more rarely occurred indistinctly in the three habitats (Figure 1B). The most preferred habitats were the agricultural and natural ones with `r pref_agr` and `r pref_nat` species over 80% of the values from null models, respectively (Figure 1B and Figure S3). In contrast, most species avoided urban habitats (`r pref_urb1` species under the 20th percentile) and just `r pref_urb2` species showed high preference for this habitat type (Figure 1B and Figure S3).

```{r, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE,fig.align="center", fig.height=12, fig.width=12,fig.cap="Figure 1. Phylogenetic relationship and habitat preferences for the selected bee species with brain weight and intertegular distance information (N=89). A) Phylogenetic tree at the genus level. Tree branches are coloured based on the geographical location of the different bee species (North of Europe, East Coast of the United States or from both regions). The deviation of the brain size in relation to the body (i.e., residuals) is represented with points of proportional size at the end of the tip branches. Larger points indicate larger brains in proportion to their body size and vice versa. B) Heatmap showing the habitat preference for each bee species. The columns delimit the habitat type (i.e., natural, agricultural and urban) and the rows the different bee species."}

library(ggtree) #v3.5.3.002
library(ggplot2)
library(stringr)
library(tidyverse)
library(tibble)

#Load phylogenetic data from europe
bee.tree100 = readRDS("../Data/Europe_USA/bee.tree100.rds")
#Load brain data
brain_weight = readr::read_csv("../Data/Processing/brain_weight_data.csv")
#Load preferences data
preferences_usa = readr::read_csv("../Data/USA_data/preferences_usa.csv") 
preferences_eu = readr::read_csv("../Data/Europe_data/preferences_europe.csv") 
#Bind rows
pref = bind_rows(preferences_usa, preferences_eu)

#Average preferences between USA and Europe
preferences = pref %>% 
group_by(Species) %>%
summarise(across(everything(), list(mean),.names = "{.col}")) %>% 
ungroup()

#Delete underscore from tree
bee.tree100$tip.label = str_replace(bee.tree100$tip.label, "_", " ")

#Generate vector with species
v = bee.tree100$tip.label
#Filter species with that are in the phylo
brain_weight = brain_weight %>% filter(Species %in% v)

#Fill a column based on condition
brain_weight = brain_weight %>% 
    mutate(Country = case_when((brain_weight$Species %in% preferences_eu$Species & 
    brain_weight$Species %in% preferences_usa$Species ~ "USA and Europe"),
    (brain_weight$Species %in% preferences_usa$Species ~ "USA"),
    (brain_weight$Species %in% preferences_eu$Species ~ "Europe")))

#Plot tree
p <- ggtree(bee.tree100) %<+% brain_weight  +  aes(color=Country)+
    geom_tippoint(aes(size = residuals, color=Country))+
    theme_tree2()+scale_size_continuous(range = c(-1, 4),name="Relative\nbrain size")+
    scale_color_manual(name = "Data", values=c("darkgoldenrod1","cyan4","black"),
                       labels = c("Europe", "USA", "USA and Europe"),
                       breaks = c("Europe", "USA", "USA and Europe")) +
  ggtitle("A") + theme(plot.title = element_text(size=18, face="bold"))

#Convert wide format to long for plotting heatmap
d=gather(preferences, condition, measurement, Agricultural:Urban, factor_key=TRUE)

#Relevel for plotting
d = d %>% 
mutate(condition=fct_relevel(condition,c("Natural","Agricultural", "Urban"))) 

p2 = ggplot(d, aes(x=condition, y=Species)) + 
    geom_tile(aes(fill=measurement),color = "white") +
   # scale_fill_gradient(high="black",  low="white") +
    scale_fill_viridis_c(name = "Habitat\npreference") + 
    theme_minimal() +
    xlab(NULL) + 
    ylab(NULL) + 
    theme(axis.text.x = element_text(face="bold", color="black", 
    size=7.5,  vjust=1.15),
    axis.text.y = element_text(face="italic", color="black", size=7.5, hjust=0),
    plot.title = element_text(size=18, face="bold")) +
   ggtitle("B")

#Nice way to insert ordered heatmap
library(aplot)
p2 %>% insert_left(p) 
```

\clearpage

We found that bee species relative brain size is associated with the habitat type preference (Figure 2A; Bayesian R$^2$ = `r r2_main`). Specifically, we found that bees with larger brains relative to body size showed a higher preference for urban habitats than bees with smaller relative brain sizes (Figure 2A). Contrarily, bees with smaller relative brains showed higher preference in natural and agricultural habitats than bees with larger relative brain sizes (Figure 2A). The models of the association between absolute brain size and intertegular span with habitat preference also showed a marked differences between habitat types (Figures 2B and 2C; Bayesian R$^2$ = `r r2_brain`; Bayesian R$^2$ = `r r2_its`, respectively). Specifically, we found that bees with larger brains and body sizes tend to appear more in urban habitats and bees with smaller brains and body sizes are more common in natural and agricultural ones (Figures 2B and 2C). These findings were consistent with the analogous analyses separated by geographical regions (United States and Europe; Figure S4).

```{r, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE,fig.align="center", fig.height=6, fig.width=10, fig.cap="Figure 2. Association between relative brain size (A), brain weight (B) and intertegular distance (C) with habitat preference by habitat type (i.e., natural, agricultural and urban). The shaded and coloured areas by habitat type represent 95\\% credible intervals.", fig.pos="p"}

#Load libraries
library(readr)
library(dplyr)
library(ggplot2)

#Load data for plotting
long_data <- read_csv("../Data/Europe_USA/data_preference_residuals_europe_usa_qualitative.csv")

model1 = read_csv("../Data/Europe_USA/model_output_preference_residuals_europe_usa_qualitative.csv")

model2 = read_csv("../Data/Europe_USA/model_output_preference_brain_weight_europe_usa_qualitative.csv")

model3 = read_csv("../Data/Europe_USA/model_output_preference_it_europe_usa_qualitative.csv")

#Relevel for plotting
long_data = long_data %>% 
    mutate(Habitat=fct_relevel(Habitat,c("Natural","Agricultural", "Urban"))) 
#Relevel for plotting
model1 = model1 %>% 
    mutate(Habitat=fct_relevel(Habitat,c("Natural","Agricultural", "Urban"))) 
#Relevel for plotting
model2 = model2 %>% 
    mutate(Habitat=fct_relevel(Habitat,c("Natural","Agricultural", "Urban"))) 
#Relevel for plotting
model3 = model3 %>% 
    mutate(Habitat=fct_relevel(Habitat,c("Natural","Agricultural", "Urban"))) 

#colorBlindness::displayAllColors(viridis::viridis(4))

set.seed(3)

all_1 = ggplot(model1, aes(x = residuals, y = estimate__, color=Habitat)) +
geom_jitter(width = 0.05, height = 0,data =  long_data, aes(x = residuals, y = (Preference)), shape=21, size=2.5) +
geom_line(aes(color=Habitat),size=0.7) +
geom_ribbon(aes(ymin = lower__, ymax = upper__,  fill = Habitat),color=NA, linetype = "dashed",alpha = 0.2)+
theme_bw() +
ylab("Habitat preference") +
xlab("Relative brain size") +
scale_colour_viridis_d() +
scale_fill_viridis_d() +
scale_y_continuous(breaks = seq(0, 1, by = 1),labels = c("Low", "High")) +
ggtitle("A") +
theme(plot.title = element_text(face = "bold", size=18))
  

all_2 = ggplot(model2, aes(x = Brain.weight, y = estimate__, color=Habitat)) +
geom_point(data =  long_data, aes(x = Brain.weight, y = (Preference)), shape=21, size=2.5) +
geom_line(aes(color=Habitat),size=0.7) +
geom_ribbon(aes(ymin = lower__, ymax = upper__,  fill = Habitat),color=NA, linetype = "dashed",alpha = 0.2)+
theme_bw() +
ylab(NULL) +
xlab("Brain weight (mg)") +
scale_colour_viridis_d() +
scale_fill_viridis_d() +
scale_y_continuous(breaks = seq(0, 1, by = 1),labels = c("Low", "High")) +
ggtitle("B") +
theme(plot.title = element_text(face = "bold", size=18))



all_3 = ggplot(model3, aes(x = IT, y = estimate__, color=Habitat)) +
geom_point(data =  long_data, aes(x = IT, y = (Preference)), shape=21, size=2.5) +
geom_line(aes(color=Habitat),size=0.7) +
geom_ribbon(aes(ymin = lower__, ymax = upper__, fill = Habitat),color=NA, linetype = "dashed",alpha = 0.2)+
theme_bw() +
ylab(NULL) +
xlab("Intertegular distance (mm)") +
scale_colour_viridis_d() +
scale_fill_viridis_d() +
scale_y_continuous(breaks = seq(0, 1, by = 1),labels = c("Low", "High")) +
ggtitle("C") +
theme(plot.title = element_text(face = "bold", size=18))

library(patchwork)

all_1 + (all_2/all_3) + plot_layout(guides = "collect") &
theme(legend.position = 'bottom', panel.border=element_rect(size=1),
      axis.title=element_text(face="bold"),
      legend.box.background = element_rect(colour = "black",size=1))

```

\clearpage

# 4. Discussion

Using data from two different continents and `r nlevels(factor(unique(raw$Species)))` bee species, we find that bees with a preference for inhabiting urban habitats tended to have larger brains relative to their body while those with forest or agricultural preferences had relatively smaller brains. These results are in line with the cognitive buffer hypothesis [@sol2009], which predicts that a large relative brain should provide enhanced behavioural plasticity to persist and thrive in novel environments. In urban environments, individuals are frequently exposed to a variety of new challenges such as novel resources or human disturbances that can change fast in time and space [@wheater2002]. In such scenarios, a large brain could confer the cognitive flexibility needed to efficiently exploit novel resources while avoiding risks. While the exact mechanisms are unclear, we expect cognitive flexibility to be essential in a variety of contexts such as the use of human-made materials for the nest [@allasino2019] or the need to collect pollen and nectar from exotic flowers [@lowenstein2019].

Also in line with the cognitive buffer hypothesis [@ducatez2020], we find that bees that proliferate in urban habitats have bigger bodies and larger absolute brains. Larger species require longer development times and obtain greater net benefits from exploring and learning, especially in heterogeneous environments [@bateman2012; @theodorou2021]. For example, the large carpenter bees of the genus _Xylocopa_ can live up to two years and are frequent urban dwellers, while small _Andrena_ forest specialists complete their adult life cycle in a few weeks. The patchiness of urban resources also seems to favour larger body sizes, as suggests the observation that foraging distance is positively associated with body size in bees [@greenleaf2007; @kendall2019]. There are also shreds of evidence that associate increased tolerance to urbanisation with wider ecological niches [@geslin2013; @buchholz2020; @prendergast2022], and both larger bodies and relative brains are thought to be features that can facilitate broader diets and niche expansion. Further understanding all these processes represent an important avenue of future research.

Overall, our findings support and expand previous evidence found in vertebrates that having a large brain size can allow survival in novel environments [@santini2019; @sayol2020b], highlighting that a cognitive buffer is possible even with tiny brains. The use of the entire brain size as a proxy for cognitive performance is not exempt from criticism [@chittka2009; @lihoreau2012]. Our analyses focused on brain size mainly for reasons of data availability. The use of brain size is justified by the existence of previous evidence that enlarged brains enhance cognitive performance in bees [@collado2021]. Moreover, brain size is less subject to measurement error or context-dependent biases in comparison with other experimental measures of cognition [@chittka2009; @lihoreau2012]. Although the use in the future of finer measures like neuropils size or mushroom bodies [the suspected centres of cognitive processes in bees\; @barth1997; @withers1995; @fahrbach1995] is likely to help improve our understanding of bee cognitive abilities. Our findings highlight the importance of behavioural responses for understanding the dynamics of insect populations in altered environments and stresses the need to avoid viewing them as passive agents of external pressures.

# Data accessibility

All occurrence data used in this study can be downloaded from <https://doi.org/10.15468/dl.5s5kuf>. In addition, bee trait data and code can be found in the online repositories of Zenodo <https://doi.org/10.5281/zenodo.8049996> and Github <https://github.com/ibartomeus/declines_brain.git>.

# Authors' contributions

IB, MAC and JBL designed the study. MAC and FS collected the data. JBL led the analysis with help from MAC and IB. JBL and IB wrote the manuscript with contributions from all authors.

# Funding

Ministerio de Economía y Competitividad, Gobierno de España, Grant/Award Number: CGL2013-47448-P.

# Acknowledgements

We thank Curro Molina, Ivo Reamakers and Parker Gambino for collecting some of the studies specimens.

# Conflict of interest declaration

We declare we have no competing interests.

\newpage

# References

::: {#refs}
:::
